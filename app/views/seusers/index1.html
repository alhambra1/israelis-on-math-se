<div ng-app="app">
  <div ng-controller="IndexController as ctrl">
    <h2>Math.StackExchange Users with Location Matching 'israel'</h2>
    <p>Page size: <input ng-model="ctrl.pageSize" /></p>
    Current page: <input type="text" ng-model="ctrl.currentPage" /> of {{ ctrl.numPages }} <button ng-click="ctrl.paginate()">Go</button>
    <p><button ng-click="ctrl.prevPage()">Prev Page</button> <button ng-click="ctrl.nextPage()">Next Page</button></p>
    <p>Filter users by text search on SE: <input type="text" ng-model="ctrl.search" /> <button ng-click="ctrl.filterUsers()">Search</button></p>
    <div class="user" ng-repeat="user in ctrl.pagedUsers">
      <div ng-repeat="(key, value) in user.user">
        <span>{{ key }}: </span> <span><a ng-href="{{ value }}" ng-if="ctrl.isLink(key)" target="_blank">{{ value }}</a><img src="{{ value }}" ng-if="ctrl.isImage(key)">{{ !ctrl.isLink(key) && !ctrl.isImage(key) ? value : '' }}</span>
      </div>
    </div>
  </div>
</div>

<script src="js/angular.min.js"></script>
<script type="text/javascript" charset="utf-8">
  angular
    .module('app',[])
    .controller('IndexController',function($http){
      var ctrl = this;

      ctrl.pageSize = 100;
      ctrl.currentPage = 1;
      ctrl.users = [];
      ctrl.numPages = 0;
           
      ctrl.prevPage = function(){
        if (ctrl.currentPage > 1){ 
          ctrl.currentPage--;
          ctrl.paginate();
        }
      }
      
      ctrl.nextPage = function(){
        if (ctrl.filteredUsers.length > ctrl.currentPage * ctrl.pageSize){ 
          ctrl.currentPage++;
          ctrl.paginate();
        }
      }
      
      ctrl.paginate = function(){
        var start = (ctrl.currentPage - 1) * ctrl.pageSize;
        ctrl.pagedUsers = ctrl.filteredUsers.slice(start, start + ctrl.pageSize);
      }
      
      ctrl.isLink = function(value){
        return /link/i.test(value);
      }
      
      ctrl.isImage = function(value){
        return /image/i.test(value);
      }
      
      ctrl.filterUsers = function(){
        function querySE(i){
          if (i == ctrl.users.length){
            return;
          }
          
          $http.get('http://stackoverflow.com/search?q=user%3A' + ctrl.users[i].user_id + '+' + encodeURIComponent(ctrl.search)).then(function(resp){
            console.log(resp.data);
          });
        }
      
        if (ctrl.search && ctrl.search.match(/\S/)){
          querySE(0);
          
        } else {
          ctrl.filteredUsers = ctrl.users;
        }
      }
      
      $http.get('/seusers.json').then(function(resp){
        ctrl.users = resp.data;
        ctrl.filterUsers();
        ctrl.numPages = Math.ceil(ctrl.filteredUsers.length / ctrl.pageSize);
        ctrl.paginate();
      });
    });
</script>
